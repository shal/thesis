
\chapter{Практична частина}

\section{Постановка задачі}

Реалізація програмного продукту ведеться за вимогами, які розглядаються як технічне завдання на розробку. Побудова архітектури й реалізація програмного
продукту повинні вестися відповідно до поставлених завдань.
Серверна частина повинна бути реалізована мовою програмування Go.
Кінцевий продукт повинен являти собою сервіс пошуку автотранспорту
за індивідуальним номерним державним знаком з двома методами
взаємодії:

\begin{itemize}
  \item Веб-додаток, що працює за протоколом «HTTP».
  \item «Telegram» чат-бот.
\end{itemize}

Створюваний продукт повинен забезпечувати можливість
надання кінцевому користувачеві послуг з пошуку інформації про
автотранспорт за індивідуальним державним номером
або зображенні, на якій чітко видно номерний державний знак.

База даних, на основі якої будується сервіс, повинна
забезпечувати охоплення всієї широти можливої ​​інформації, яка може бути
цікава кінцевому користувачеві. Під кінцевим користувачем сервісу
розуміється користувач чат-бота чи будь-якої іншої реалізації клієнтської частини.

Передбачається, що сервіс повинен компілюватися на більшості операційних системах,
а тобто «Linux», «MacOS», «Windows».
Оскільки основною мовою програмування повинна бути Go, ми отримаємо змогу
розгорнути проект на наступних операційних системах:
«Linux», «Windows», «MacOS», «OpenBSD», «DragonFly BSD», «FreeBSD», «NetBSD», «Native Client», «Solaris».
Ця мова програмування є компільованою на багатьох операційних системах задля того, щоб процес розгортання
системи був максимально простим, саме тому її називають «Cloud Native».

Веб-сервіс повинен обмінюватися повідомленнями з кінцевими
користувачами за «REST» протоколом, також він повинен
надавати кілька типів пошуку за параметрами і мати можливість
повертати результат як одиничною відповіддю, так і масивом відповідей.
Під відповіддю мається на увазі полегшена модель даних автотранспорту.

REST — це архітектурний стиль взаємодії компонентів розподіленого додатка в мережі,
а точніше узгоджений набір обмежень, що враховуються при проектуванні розподіленої системи.
У певних випадках це призводить до підвищення продуктивності та спрощення архітектури.
В мережі Інтернет виклик віддаленої процедури може являти собою звичайний «HTTP-запит»,
а необхідні дані передаються як параметри запиту.
До веб-додатків, побудованих з урахуванням «REST», застосовують термін «RESTful».

Сервіс повинен бути захищений від найбільш розповсюджених уражень.
Найбільш відомою організацією, що досліджує ураження в мережі Інтернет є «OWASP»,
тож будемо спиратися на їх дослідження.

\begin{enumerate}
  \item Помилки у перевірці.
  \item Недоліки в системі аутентифікації.
  \item Розкриття чутливої інформації.
  \item Порушений контроль доступу.
  \item Впровадження зовнішніх XML-сутностей.
  \item Помилки в конфігурації.
  \item Міжсайтовий скриптинг.
  \item Небезпечна обробка JSON-сутностей.
  \item Використання компонентів з відомими ураженнями.
  \item Недостатній рівень моніторингу.
\end{enumerate}

Принципова схема роботи системи представлена на рис.~\ref{fig:user-system-overview}.

\section{Побудова архітектури системи}

Під архітектурою програмного продукту зазвичай мають на увазі
сукупність найважливіших рішень щодо організації структури програмного
продукту.
У цьому розділі розглядаються такі аспекти моделі продукту:

\begin{itemize}
  \item Склад вхідних даних.
  \item Модульність компонентів.
  \item Схеми взаємодії компонентів.
  \item Структура таблиці бази даних.
\end{itemize}

Найбільш сучасний підхід до реалізації програмних продуктів такого типу це мікро-сервіси.

Мікро-сервіси — архітектурний стиль за яким єдиний застосунок будується
як сукупність невеличких сервісів кожен з яких працює у своєму власному
процесі і комунікує з рештою використовуючи певні протоколи обміну,
зазвичай HTTP. Ці сервіси будуються навколо бізнес-потреб та розгортаються
незалежно з використанням повністю автоматизованого середовища.
Самі по собі сервіси можуть бути написані з використанням різних мов і технологій
зберігання даних.

Основні переваги:

\begin{itemize}
  \item Високий рівень незалежності сервісів.
  \item Простота заміни однієї реалізації сервісу іншою.
  \item Простота додавання нового функціоналу в систему.
  \item Ефективне використання ресурсів.
  \item Вихід з ладу одного сервісу не призводить до виходу з ладу всієї системи.
  \item Сервіси організовані відносно бізнес логіки яку вони виконують.
  \item Кожен сервіс незалежно від інших може бути реалізований.
\end{itemize}

Отже, розділимо додаток на п'ять логічних складових,
кожна з яких відповідає безпосередньо на одну функцію.
Це дає змогу розробляти якісніші програмні продукти,
оскільки кожен з додатків вирішує конкретне завдання.

Схема роботи системи зображена на рис.~\ref{fig:architecture-overview}.
Задача розгортання сховища даних є досить тривіальною.
За сховище було обрано реляційну базу даних PostgreSQL,
яка вже багато разів зарекомендувала себе як швидка та надійна.

\textbf{Чат-бот сервіс.}

Інтерфейс комунікації між месенджером та чат-бот сервісом влаштований наступним чином:
коли користувач відправляє повідомлення, Telegram відправляє HTTP запит до сервісу,
який у свою чергу обробивши запит робить відповідний виклик до Bot API.

\textbf{Детекція державних номерних знаків на зображенні.}
Задача розпізнавання тексту на зображеннях є дуже цікавою темою.
У відкритому доступі існує величезна кількість цікавих рішень, проте
знайти бібліотеку що є безкоштовною та підтримує
українські державні номери автотранспорту виявилося досить просто.

«OpenALPR Cloud API» — це веб-сервіс, що аналізує зображення транспортних засобів та розпізнає
дані ліцензійних номерів, а також колір, марку, модель і тип кузова.
Насправді, цей сервіс досить дорогий, проте він реалізований на основі
бібліотеки «OpenALPR», яка у свою чергу знаходиться у вільному доступі в мережі.

Таким чином, розробимо веб сервіс, що приймає на вхід зображення,
досліджує її за допомогою бібліотеки та повертає результат у вигляді державного номера.

\textbf{Оброблювач вхідних даних.}
Міністерство Внутрішніх Справ України публікує дані про транспортні засоби та їх власників раз у
місяць, зазвичай у перших числах календарного місяця.
Дані надходять у вигляді величезних CSV документів, які можуть змінені у будь-який момент.
Оскільки ніхто не гарантує, що формат
цих даних незмінний — автоматизувати їх обробку є досить складним завданням, а тому не будемо
робити дослідження цієї проблеми в рамках цієї роботи.

Отже кожного місяця потрібно ефективно та швидко обробляти нову інформацію
про транспортні за засоби.
Оскільки дані зберігаються у вигляді CSV документів, а час пошуку будь-яких даних у цих документах
досить великий, оброблювач повинен читати ці дані та записувати їх у спеціальному
вигляді до бази даних, а пошук у проіндексованих таблицях досить швидкий.
Дослідивши сучасні підходи до розробки багато-поточних
систем за технологією MapReduce у попередніх розділах, можна реалізувати досить швидкий та
надійний до запобігання помилок оброблювач CSV документів.

Алгоритм роботи та деталі реалізації цієї компоненти буде розглянуто у наступних підрозділах.

\textbf{Головний веб-сервіс.}
Кінцевий крок — швидкісний сервер пошуку автотранспорту за
державним номером у базі даних.

Розділивши логіку на складові, задача пошуку номерів тепер здається на рівень легшою,
потрібно лише обрати правильні інструменти,
а тобто швидку та надійну мову програмування та базу даних.

Алгоритм роботи та деталі реалізації цієї компоненти буде розглянуто у наступних підрозділах.

\section{Розробка серверної частини}

До серверної частини відносяться сервіси, що мають наступні три мети:

\begin{itemize}
  \item Обробка вхідних даних.
  \item Пошук даних.
  \item Розпізнання державних номерів на зображеннях.
\end{itemize}

Пропонуємо більш детально оглянути, яким чином це буде реалізовано,
у наступних підрозділах.

\textbf{Обробка вхідних даних.}
У цьому підрозділі буде детально розглянуто алгоритм обробки даних.
Головною метою цього розділу є знаходження та демонстрація чіткого алгоритму,
який може бути застосований до будь-яких типів даних, що знаходяться у відкритому доступі
на єдиному порталі відкритих даних України.

Отже, одним з найважливіших аспектів цієї дипломної роботи є швидкість оброки великих масивів даних.
Підсумовуючи викладений у попередніх розділах матеріал, можна стверджувати, що одним
з найкращих технологій оброки даних є MapReduce, тож саме цей метод був узятий за основу розробленого алгоритму.

Слід зазначити дуже гарні результати у пошуку проіндексованих даних
у реляційних базах даних.
На рис.~\ref{fig:sql-queries-psql} бачимо близько десяти тис. запитів на секунду,
що є достатнім майже для будь-якої системи.
У цьому дослідження було використано базу даних PostgreSQL,
тому що вона має перевагу над іншими у швидкості пошуку та індексації,
а також ця база підтримує складні структури даних,
має велику кількість різноманітних типів даних та
дуже надійна у збереженні великих масивів даних.

Розглянемо детальніше структуру CSV документів та алгоритм оброки.
У табл.~\ref{fig:csv-documet-structure} можна побачити список полів, що містить кожний документ.
Як бачимо, дані можуть бути оброблені в альтернативний формат, тож побудуємо
SQL таблицю для збереження даних про операції над транспортними засобами.

На рис.~\ref{fig:parser-overview} роботи обробника CSV документів у SQL можна побачити, що алгоритм має п'ять кроків.
На першому кроці програма створює новий об'єкт читання з документа формату CSV, для того щоб читати та групувати дані з файлу у невеличкі масиви рядків.
З першого на другий крок дані потрапляють через так званий «channel».
Це примітив у мові програмування Go, що є аналогом черги для декількох процесів.
На другому кроці програма постійно групує дані у масиви по N елементів, а потім передає їх через до наступної частини програми.
Процес безпосередньої обробки та перевірці є досить складним через виділення нової пам'яті та роботи зі строками.
Для пришвидшення було створено декілька процесів, що постійно чекають на масиви даних, які потрібні бути оброблені.
Після третього кроку, що насправді є прикладом функції Map у MapReduce, оброблені дані потрапляють до 4 кроку.
На четвертому кроці програма знову групує дані у масиви по M елементів, а потім передає їх через до фінального кроку.
На останньому кроці масив отриманих даних публікується до сховища.

Навіщо потрібно групувати дані на масиви,
адже це може сповільнити процес обробки спитає недосвідчений розробник.
Операції на масивах даних відбуваються в декілька разів швидше, тому що мінімізується час на відправлення та оброку повідомлень.
Гарним прикладом може бути процес читання з файлу.
Читання одразу декількох стрічок пришвидшує алгоритм у 5 разів,
головне не перебільшити та раціонально використовувати оперативну пам'ять машини.

\textbf{Пошук даних.}
Пошук даних реалізовано через веб-інтерфейс, що отримує на вхід державний номер та
повертає список операцій, у яких фігурує даний державний номер.
Ця компонента має прямий доступ до бази даних, у якій зберігаються дані про транспорті засоби.
Такий підхід гарантує мінімальний час на пошуковий SQL запит.

Цей інтерфейс реалізує технологію REST, що була розглянута у теоретичній частині цієї дипломної роботи.
Тож протокол який використовується — HTTP, а формат відповіді та запиту сервера — JSON.
Такі характеристики дають можливість використовувати
цей інтерфейс без будь-яких обмежень.

Таким чином, при отриманні нового HTTP GET запиту, сервер оброблює його та декодує
передані параметри, а тобто номерний державний знак та максимальну кількість операцій, що можуть бути повернені.
На наступному кроці відбувається пошуковий SQL запит, що повинен отримати усі потрібні дані.
Результат отриманий від бази обробляється та повертається до кінцевого користувача у вигляді JSON відповіді.
Увесь процес не повинен займати більш ніж декілька мілісекунд,
якщо дані проіндексовані та правильно оброблені.

Важливим аспектом пошуку є форматування символів номерного державного знаку.
Дані у сховищі зберігаються в вигляді кирилиці, а літери у запиті можуть мати інші формати.
Аби запобігти цю проблему, на кожному запиті номер транслітерується у кирилічний аналог,
таким чином гарантується запобігання будь-яких інших літер.

Усі функції цієї компоненти були протестовані, також було оцінено швидкість роботи інтерфейсу.
На рис.~\ref{fig:opencars-service-performance} бачимо,
що сервіс може обробляти від 200 до 500 запитів на секунду.
Приблизно такі самі результати можна отримати,
якщо використовувати сервіс за допомогою чат-бота.
Якщо використовувати більші ресурси, наприклад спеціалізований
окремий сервер з базою даних, то можна отримати більш ніж
3 тис. запитів на секунду, тож є величезний запас швидкості.

Сервіс реалізований стандартними засобами мови програмування Go,
що були створені кращими світовими розробниками з компанії Google.

\textbf{Розпізнання державних номерів на зображенні.}
OpenALPR — це бібліотека автоматичного розпізнавання
державних номерних знаків з відкритим вихідним кодом,
написана на C++ з можливостями використовуватися у Java, Node.js і Python.
Бібліотека аналізує зображення та відео для ідентифікації номерних знаків.
Вихідні дані — це текстове представлення державного номерного знака.

Програмне забезпечення можна використовувати різними способами.
У нашому випадку потрібно розробити веб-сервіс, вхідними даними якого буде зображення, а
вихідними буде номерний знак.

Дана бібліотека створена для американських номерних знаків,
проте її можна навчити розпізнавати й українські державні номерні знаки.

Оптичне розпізнавання тексту — це механічне або електронне переведення
зображень рукописного, машинописного або друкованого тексту в послідовність
кодів, що використовуються для представлення в текстовому редакторі.
Розпізнавання широко використовується для конвертації книг і документів
в електронний вигляд, для автоматизації систем обліку в бізнесі або
для публікації тексту на веб-сторінці.
Оптичне розпізнавання тексту дозволяє редагувати текст,
здійснювати пошук слова або фрази, зберігати його в компактнішій формі,
демонструвати матеріал, не втрачаючи якості,
аналізувати інформацію, а також застосовувати до тексту електронний переклад,
форматування або перетворення в мовлення.
Оптичне розпізнавання тексту є досліджуваною проблемою в галузях розпізнавання образів,
штучного інтелекту і комп'ютерного зору.

Системи оптичного розпізнавання тексту вимагають калібрування для
роботи з конкретним шрифтом, тому бібліотеку OpenALPR потрібно
навчити розпізнавати шрифт українських номерних знаків.
Таким чином, за допомогою двох сотень зображень та декількох
годин тренування моделі отримано результат у вигляді 80\%
розпізнання номерних знаків.

\section{Розробка клієнтської частини}

До клієнтської частини належить лише сервіс чат-боту.

Чат-бот — це програмне забезпечення штучного інтелекту, що може імітувати бесіду з користувачем природною мовою через спеціалізовані програми для обміну повідомленнями.
Ця технологія часто описується як один з найбільш передових і перспективних
методів взаємодії між людьми й машинами.
Однак, з технологічної точки зору, чат-бот представляє лише природну
еволюцію системи відповіді на запитання.
Формулювання відповідей на питання природною мовою є одним з найбільш
типових прикладів обробки природної мови, що застосовується в кінцевих
додатках різних підприємств.

У контексті системи Telegram, боти — це програми сторонніх розробників,
які працюють у системі Telegram.
Користувачі можуть взаємодіяти з ботами, надсилаючи їм повідомлення,
команди та спеціалізовані запити.
Розробники можуть керувати своїми ботами за допомогою HTTP-запитів до Telegram Bot API.

Як зображено на рис. \ref{fig:bot-sequence-diagram}, чат-бот є лише простим сервером, що відповідає на певний запит від Telegram.
На початку роботи чат-бота, сервер повідомлює адресу системі.
При надходженні повідомлення до бота, система робить запит на сервер з ботом,
після оброки запиту сервіс чат-бота відповідний запит з повідомленням, що повинно бути
відправлене користувачу.

Таким чином, наш сервер повинен обробити текстове повідомлення або зображення від користувача.
Чат-бот зробить запит до сервісу пошуку даних та сконструювати
текстову відповідь з отриманого JSON, а потім відправити її до серверів Telegram.
